<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebQuizzer â€“ Administration</title>
    <link rel="stylesheet" href="/home.css" />
    <link rel="stylesheet" href="/admin.css" />
</head>

<body>
    <aside class="side-nav">
        <div class="logo">WebQuizzer</div>
        <nav class="side-menu">
            <a href="/" class="side-link">Accueil</a>
            <a href="/quizzes/all" class="side-link">Tous les quiz</a>
            <a href="/quizzes/mine" class="side-link">Mes quiz</a>
            <a href="/quizzes/new" class="side-link create">CrÃ©er</a>
            <a href="/admin" class="side-link create active">Admin</a>
            <a href="/profile" class="side-link profile-link">ðŸ‘¤ <span>Profil</span></a>
        </nav>
        <div class="side-footer">
            <p id="welcome"></p>
            <a href="/login" id="authButton" class="btn-side-login">Connexion</a>
        </div>
    </aside>

    <main class="main">
        <div class="page-header">
            <h1>Administration</h1>
            <p class="subtitle">GÃ©rez les utilisateurs de la plateforme</p>
        </div>

        <% if (typeof message !=='undefined' && message) { %>
            <div class="flash">
                <%= message %>
            </div>
            <% } %>

                <div class="admin-table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>RÃ´le</th>
                                <th style="width:200px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (users && users.length) { %>
                                <% users.forEach(u=> { %>
                                    <tr>
                                        <td><strong>#<%= u.id %></strong></td>
                                        <td>
                                            <%= u.nom %>
                                        </td>
                                        <td>
                                            <%= u.email %>
                                        </td>
                                        <td>
                                            <span
                                                class="badge <%= u.role === 'admin' ? 'badge-admin' : 'badge-user' %>">
                                                <%= u.role %>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="actions">
                                                <button class="btn-edit"
                                                    data-open-modal="edit-<%= u.id %>">Modifier</button>
                                                <form method="POST" action="/admin/users/<%= u.id %>/delete"
                                                    onsubmit="return confirm('Supprimer <%= u.nom %> ?');">
                                                    <button class="btn-delete" type="submit">Supprimer</button>
                                                </form>
                                            </div>

                                            <div class="modal" id="edit-<%= u.id %>">
                                                <div class="modal-card">
                                                    <div class="modal-head">
                                                        <div class="modal-title">Modifier <%= u.nom %>
                                                        </div>
                                                        <button class="btn-close"
                                                            data-close-modal="edit-<%= u.id %>">âœ•</button>
                                                    </div>
                                                    <form method="POST" action="/admin/users/<%= u.id %>/update"
                                                        onsubmit="return confirm('Confirmer la modification ?');">
                                                        <div class="modal-body">
                                                            <div class="form-group">
                                                                <label>Nom</label>
                                                                <input type="text" name="nom" value="<%= u.nom %>"
                                                                    required />
                                                            </div>
                                                            <div class="form-group">
                                                                <label>Email</label>
                                                                <input type="email" name="email" value="<%= u.email %>"
                                                                    required />
                                                            </div>
                                                            <div class="form-group">
                                                                <label>RÃ´le</label>
                                                                <select name="role" required>
                                                                    <option value="user" <%=u.role==='user' ? 'selected'
                                                                        : '' %>>User</option>
                                                                    <option value="admin" <%=u.role==='admin'
                                                                        ? 'selected' : '' %>>Admin</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="modal-actions">
                                                            <button type="button" class="btn-cancel"
                                                                data-close-modal="edit-<%= u.id %>">Annuler</button>
                                                            <button type="submit" class="btn-save">Enregistrer</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <% }) %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="5" class="no-users">Aucun utilisateur trouvÃ©.</td>
                                            </tr>
                                            <% } %>
                        </tbody>
                    </table>
                </div>
    </main>

    <script>
        const me = JSON.parse('<%- JSON.stringify(user || null) %>');

        const welcome = document.getElementById("welcome");
        const authBtn = document.getElementById("authButton");
        if (me) {
            welcome.textContent = "Bonjour " + me.nom;
            authBtn.textContent = "DÃ©connexion";
            authBtn.href = "#";
            authBtn.onclick = async (e) => {
                e.preventDefault();
                await fetch("/logout", { credentials: "include" });
                location.href = "/";
            };
        }

        setTimeout(() => {
            const msg = document.querySelector('.flash');
            if (msg) msg.style.opacity = '0';
            setTimeout(() => { if (msg) msg.style.display = 'none'; }, 300);
        }, 3000);

        document.addEventListener('click', e => {
            const open = e.target.closest('[data-open-modal]');
            const close = e.target.closest('[data-close-modal]');
            if (open) {
                const id = open.getAttribute('data-open-modal');
                document.getElementById(id)?.classList.add('open');
            }
            if (close) {
                const id = close.getAttribute('data-close-modal');
                document.getElementById(id)?.classList.remove('open');
            }
        });

        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', e => {
                if (e.target === m) m.classList.remove('open');
            });
        });
    </script>
</body>

</html>