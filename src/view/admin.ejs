<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebQuizzer ‚Äì Administration</title>
    <link rel="stylesheet" href="/home.css" />
    <link rel="stylesheet" href="/admin.css" />
</head>

<body>
    <aside class="side-nav">
        <div class="logo">WebQuizzer</div>
        <nav class="side-menu">
            <a href="/" class="side-link">Accueil</a>
            <a href="/quizzes/all" class="side-link">Tous les quiz</a>
            <a href="/quizzes/mine" class="side-link">Mes quiz</a>
            <a href="/quizzes/new" class="side-link create">Cr√©er</a>
            <a href="/admin" class="side-link create active">Admin</a>
            <a href="/profile" class="side-link profile-link">üë§ <span>Profil</span></a>
        </nav>
        <div class="side-footer">
            <p id="welcome"></p>
            <a href="/login" id="authButton" class="btn-side-login">Connexion</a>
        </div>
    </aside>

    <main class="main">
        <div class="page-header">
            <h1>Administration</h1>
            <p class="subtitle">G√©rez les utilisateurs de la plateforme</p>
        </div>

        <% if (typeof message !=='undefined' && message) { %>
            <div class="flash">
                <%= message %>
            </div>
        <% } %>

        <div class="admin-table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>R√¥le</th>
                        <th style="width:250px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (users && users.length) { %>
                        <% users.forEach(u=> { %>
                            <tr>
                                <td><strong>#<%= u.id %></strong></td>
                                <td><%= u.nom %></td>
                                <td><%= u.email %></td>
                                <td>
                                    <span class="badge <%= u.role === 'admin' ? 'badge-admin' : 'badge-user' %>">
                                        <%= u.role %>
                                    </span>
                                </td>
                                <td>
                                    <div class="actions">
                                        <button class="btn-edit" data-open-modal="edit-<%= u.id %>">Modifier</button>
                                        <button class="btn-password" data-open-modal="password-<%= u.id %>"> MDP</button>
                                        <form method="POST" action="/admin/users/<%= u.id %>/delete"
                                            onsubmit="return confirm('Supprimer <%= u.nom %> ?');">
                                            <button class="btn-delete" type="submit">Supprimer</button>
                                        </form>
                                    </div>

                                    <!-- MODALE MODIFICATION -->
                                    <div class="modal" id="edit-<%= u.id %>">
                                        <div class="modal-card">
                                            <div class="modal-head">
                                                <div class="modal-title">Modifier <%= u.nom %></div>
                                                <button class="btn-close" data-close-modal="edit-<%= u.id %>">‚úï</button>
                                            </div>
                                            <form method="POST" action="/admin/users/<%= u.id %>/update"
                                                onsubmit="return confirm('Confirmer la modification ?');">
                                                <div class="modal-body">
                                                    <div class="form-group">
                                                        <label>Nom</label>
                                                        <input type="text" name="nom" value="<%= u.nom %>" required />
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Email</label>
                                                        <input type="email" name="email" value="<%= u.email %>" required />
                                                    </div>
                                                    <div class="form-group">
                                                        <label>R√¥le</label>
                                                        <select name="role" required>
                                                            <option value="user" <%=u.role==='user' ? 'selected' : '' %>>User</option>
                                                            <option value="admin" <%=u.role==='admin' ? 'selected' : '' %>>Admin</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="modal-actions">
                                                    <button type="button" class="btn-cancel" data-close-modal="edit-<%= u.id %>">Annuler</button>
                                                    <button type="submit" class="btn-save">Enregistrer</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- MODALE CHANGEMENT DE MOT DE PASSE -->
                                    <div class="modal" id="password-<%= u.id %>">
                                        <div class="modal-card">
                                            <div class="modal-head">
                                                <div class="modal-title"> Changer le mot de passe de <%= u.nom %></div>
                                                <button class="btn-close" data-close-modal="password-<%= u.id %>">‚úï</button>
                                            </div>
                                            <form method="POST" action="/admin/users/<%= u.id %>/password"
                                                onsubmit="return confirm('Changer le mot de passe de <%= u.nom %> ?');">
                                                <div class="modal-body">
                                                    <div class="warning-box">
                                                        <strong>‚ö†Ô∏è Attention :</strong> Vous √™tes sur le point de changer le mot de passe de cet utilisateur. Il devra utiliser le nouveau mot de passe pour se connecter.
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Nouveau mot de passe</label>
                                                        <input type="password" name="password" minlength="8" required placeholder="Minimum 8 caract√®res" />
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Confirmer le mot de passe</label>
                                                        <input type="password" name="passwordConfirm" minlength="8" required placeholder="Retapez le mot de passe" />
                                                    </div>
                                                </div>
                                                <div class="modal-actions">
                                                    <button type="button" class="btn-cancel" data-close-modal="password-<%= u.id %>">Annuler</button>
                                                    <button type="submit" class="btn-save">Changer le mot de passe</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="5" class="no-users">Aucun utilisateur trouv√©.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        const me = JSON.parse('<%- JSON.stringify(user || null) %>');
        const welcome = document.getElementById("welcome");
        const authBtn = document.getElementById("authButton");

        if (me) {
            welcome.textContent = "Bonjour " + me.nom;
            authBtn.textContent = "D√©connexion";
            authBtn.href = "#";
            authBtn.onclick = async (e) => {
                e.preventDefault();
                await fetch("/logout", { credentials: "include" });
                location.href = "/";
            };
        }

        setTimeout(() => {
            const msg = document.querySelector('.flash');
            if (msg) msg.style.opacity = '0';
            setTimeout(() => { if (msg) msg.style.display = 'none'; }, 300);
        }, 3000);

        document.addEventListener('click', e => {
            const open = e.target.closest('[data-open-modal]');
            const close = e.target.closest('[data-close-modal]');
            if (open) {
                const id = open.getAttribute('data-open-modal');
                document.getElementById(id)?.classList.add('open');
            }
            if (close) {
                const id = close.getAttribute('data-close-modal');
                document.getElementById(id)?.classList.remove('open');
            }
        });

        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', e => {
                if (e.target === m) m.classList.remove('open');
            });
        });
    </script>
</body>
</html>
