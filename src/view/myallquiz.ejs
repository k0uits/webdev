<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/img/Logo.png">
    <title>WebQuizzer ‚Äì Tous les quiz</title>
    <link rel="stylesheet" href="/allquiz.css" />
    <link rel="stylesheet" href="/home.css" />
</head>

<body>
    <aside class="side-nav">
        <div class="logo">WebQuizzer</div>
        <nav class="side-menu">
            <a href="/" class="side-link">Accueil</a>
            <a href="/quizzes/all" class="side-link" id="all-link">Tous les quiz</a>
            <a href="/quizzes/mine" class="side-link" id="mine-link">Mes quiz</a>
            <a href="/quizzes/new" class="side-link create">Cr√©er</a>
            <% if (user && user.role==="admin" ) { %>
                <a href="/admin" class="side-link create">Admin</a>
                <% } %>
                    <a href="/profile" class="side-link profile-link">üë§ <span>Profil</span></a>
        </nav>
        <div class="side-footer">
            <p id="welcome"></p>
            <a href="/login" id="authButton" class="btn-side-login">Connexion</a>
        </div>
    </aside>

    <main class="main">
        <div class="page-header">
            <h1 id="page-title">üåê Tous les quiz</h1>
            <p id="page-subtitle" class="subtitle">D√©couvrez tous les quiz disponibles</p>
        </div>

        <div class="search-container">
            <input id="quizSearch" type="text" class="search-input" placeholder="üîç Rechercher un quiz..." />
        </div>

        <div class="cat-toolbar"
            style="display:flex; align-items:center; justify-content:space-between; gap:16px; margin: 8px 0 12px;">
            <div class="cat-actions-left" style="display:flex; gap:8px;">
                <% if (user && user.role==="admin" ) { %>
                    <button id="btnAddCat" class="save" type="button" style="padding:8px 12px;">+ Ajouter une
                        cat√©gorie</button>
                    <% } %>
            </div>
            <div class="cat-actions-right">
                <button id="btnToggleFilter" class="ghost" type="button" style="padding:8px 12px;">Filtre ‚ñæ</button>
            </div>
        </div>

        <div id="catPanel" style="display:none; margin-bottom:12px;">
            <div id="catChips" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
        </div>

        <div id="cards-grid" class="quiz-grid"></div>

        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-state-icon">üì≠</div>
            <h2>Aucun quiz disponible</h2>
        </div>
    </main>

    <!-- Donn√©es serveur expos√©es -->
    <script>
        window.currentUser = JSON.parse('<%- JSON.stringify(user || null) %>');
        window.pageMode = "<%= mode %>";
    </script>

    <script>
        const btnToggleFilter = document.getElementById("btnToggleFilter");
        const catPanel = document.getElementById("catPanel");
        const catChips = document.getElementById("catChips");
        const btnAddCat = document.getElementById("btnAddCat");
        let selectedCategory = "";

        const isAdmin = !!(window.currentUser && window.currentUser.role === "admin");

        if (btnToggleFilter && catPanel) {
            btnToggleFilter.addEventListener("click", () => {
                const open = catPanel.style.display !== "none";
                catPanel.style.display = open ? "none" : "block";
                btnToggleFilter.textContent = open ? "Filtre ‚ñæ" : "Filtre ‚ñ¥";
            });
        }

        async function deleteCategoryByName(label) {
            try {
                // 1er essai : suppression "normale"
                let resp = await fetch("/categories/" + encodeURIComponent(label), {
                    method: "DELETE"
                });
                let data = await resp.json().catch(() => ({}));

                if (resp.ok) {
                    if (selectedCategory === label) selectedCategory = "";
                    await loadCategories();
                    applyFilters();
                    return true;
                }

                // Si la cat√©gorie est utilis√©e ‚Üí 409 ; on propose de forcer
                if (resp.status === 409) {
                    const ok = confirm((data.message || "Cat√©gorie utilis√©e par des quiz.")
                        + "\n\nForcer la suppression ? (les quiz garderont la valeur de cat√©gorie enregistr√©e, mais elle ne sera plus list√©e)");
                    if (!ok) return false;

                    // 2e essai : suppression forc√©e
                    resp = await fetch("/categories/" + encodeURIComponent(label) + "?force=1", {
                        method: "DELETE"
                    });
                    data = await resp.json().catch(() => ({}));

                    if (!resp.ok) {
                        alert(data.message || "Suppression forc√©e impossible");
                        return false;
                    }

                    if (selectedCategory === label) selectedCategory = "";
                    await loadCategories();
                    applyFilters();
                    return true;
                }

                // Autres erreurs
                alert(data.message || "Suppression impossible");
                return false;
            } catch (e) {
                alert("Erreur r√©seau.");
                return false;
            }
        }

        async function loadCategories() {
            try {
                const r = await fetch("/categories");
                const arr = await r.json();
                renderChips(Array.isArray(arr) ? arr : []);
            } catch {
                // fallback : extraire depuis les quiz si l‚ÄôAPI est vide/HS
                renderChips(extractCategoriesFromQuizzes(quizzes));
            }
        }

        function extractCategoriesFromQuizzes(list) {
            const set = new Set();
            (Array.isArray(list) ? list : []).forEach(q => {
                const c = (q.categorie || "").trim();
                if (c) set.add(c);
            });
            return Array.from(set);
        }

        function renderChips(list) {
            if (!catChips) return;
            catChips.innerHTML = "";

            // Chip "Tous"
            const allChip = document.createElement("button");
            allChip.type = "button";
            allChip.className = "cat-chip" + (selectedCategory === "" ? " active" : "");
            allChip.textContent = "Tous";
            allChip.addEventListener("click", () => {
                selectedCategory = "";
                updateChipActive();
                applyFilters();
            });
            catChips.appendChild(allChip);

            // Les autres cat√©gories
            list.forEach(label => {
                const chip = document.createElement("button");
                chip.type = "button";
                chip.className = "cat-chip" + (selectedCategory === label ? " active" : "");
                chip.textContent = label;

                chip.addEventListener("click", () => {
                    selectedCategory = (selectedCategory === label) ? "" : label;
                    updateChipActive();
                    applyFilters();
                });

                // Petite croix pour admin
                if (isAdmin) {
                    chip.classList.add("has-x");
                    const x = document.createElement("span");
                    x.className = "cat-x";
                    x.textContent = "√ó";
                    x.title = "Supprimer la cat√©gorie";
                    x.addEventListener("click", async (e) => {
                        e.stopPropagation(); // ne d√©clenche pas le filtre
                        const ok = confirm(`Supprimer la cat√©gorie ¬´ ${label} ¬ª ?`);
                        if (!ok) return;
                        await deleteCategoryByName(label);
                    });
                    chip.appendChild(x);
                }

                catChips.appendChild(chip);
            });
        }

        function updateChipActive() {
            document.querySelectorAll(".cat-chip").forEach(el => {
                const val = el.textContent;
                el.classList.toggle("active", (selectedCategory === "" && val === "Tous") || val === selectedCategory);
            });
        }

        // bouton admin pour ajouter une cat√©gorie
        if (btnAddCat) {
            btnAddCat.addEventListener("click", async () => {
                const name = (prompt("Nom de la nouvelle cat√©gorie ?") || "").trim();
                if (!name) return;
                try {
                    const resp = await fetch("/categories", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ name })
                    });
                    const data = await resp.json().catch(() => ({}));
                    if (!resp.ok) {
                        alert(data.message || "Impossible d'ajouter la cat√©gorie.");
                        return;
                    }
                    await loadCategories();
                    alert("Cat√©gorie ajout√©e ‚úÖ");
                } catch (e) {
                    alert("Erreur r√©seau.");
                }
            });
        }

        // Filtrage combin√© recherche + cat√©gorie
        function normalize(s) { return (s || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); }

        window.applyFilters = function () {
            const term = normalize((document.getElementById("quizSearch")?.value) || "");
            let items = window.baseFiltered ? window.baseFiltered.slice() : [];
            if (selectedCategory) {
                const nc = normalize(selectedCategory);
                items = items.filter(q => normalize(q.categorie) === nc);
            }
            if (term) {
                items = items.filter(q => normalize(q.titre).startsWith(term));
            }
            window.render(items);
        };

        // apr√®s render(baseFiltered);
        document.addEventListener("DOMContentLoaded", () => {
            const mode = window.pageMode;
            const allLink = document.getElementById("all-link");
            const mineLink = document.getElementById("mine-link");
            const title = document.getElementById("page-title");
            const subtitle = document.getElementById("page-subtitle");

            if (mode === "mine") {
                mineLink.classList.add("active");
                allLink.classList.remove("active");
                title.textContent = "Mes quiz";
                subtitle.textContent = "G√©rez vos propres quiz cr√©√©s";
            } else {
                allLink.classList.add("active");
                mineLink.classList.remove("active");
                title.textContent = "üåê Tous les quiz";
                subtitle.textContent = "D√©couvrez tous les quiz disponibles";
            }
        });
    </script>

    <!-- Gestion connexion / d√©connexion -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const welcome = document.getElementById("welcome");
            const authBtn = document.getElementById("authButton");
            const me = window.currentUser || null;

            if (me) {
                welcome.textContent = "Bonjour " + me.nom;
                authBtn.textContent = "D√©connexion";
                authBtn.href = "#";
                authBtn.onclick = async (e) => {
                    e.preventDefault();
                    try {
                        await fetch("/logout", { method: "GET", credentials: "include" });
                        window.location.href = "/";
                    } catch (err) {
                        alert("Erreur lors de la d√©connexion !");
                    }
                };
            } else {
                welcome.textContent = "";
                authBtn.textContent = "Connexion";
                authBtn.href = "/login";
                authBtn.onclick = null;
            }
        });
    </script>

    <!-- Affichage des quiz + suppression -->
    <script>
        document.addEventListener("DOMContentLoaded", async () => {

            const grid = document.getElementById("cards-grid");
            if (!grid) return;

            const me = window.currentUser || null;
            const mode = window.pageMode;

            const normalize = (s) =>
                (s || "").toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

            const createCard = (quiz) => {
                const card = document.createElement("div");
                card.className = "quiz-card";
                card.setAttribute("data-quiz-id", quiz.id);
                card.innerHTML = `
                    <div class="thumb" style="
                        ${quiz.image
                            ? `background-image:url('${quiz.image}');
                            background-size:cover;
                            background-position:center;
                            border:none;`
                        : ''}
                    "></div>
                    <div class="title">${quiz.titre}</div>
                `;


                card.style.cursor = "pointer";
                card.addEventListener("click", () => {
                    var back = "";
                    if (mode === "all") {
                        back = "?from=all";
                    } else {
                        if (mode === "mine") {
                            back = "?from=mine";
                        }
                    }
                    location.href = "/quizzes/" + encodeURIComponent(quiz.id) + back;
                });

                const canDelete =
                    quiz && quiz.id && quiz.id !== "#" &&
                    me &&
                    (me.role === "admin" || String(me.id) === String(quiz.auteurId || quiz.ownerId));

                if (canDelete) {
                    const controls = document.createElement("div");
                    controls.className = "card-controls";

                    const delBtn = document.createElement("button");
                    delBtn.type = "button";
                    delBtn.className = "btn-delete";
                    delBtn.textContent = "Supprimer";
                    delBtn.addEventListener("click", async (e) => {
                        e.stopPropagation();
                        if (!confirm("Supprimer ce quiz ?")) return;
                        try {
                            const resp = await fetch("/quizzes/" + encodeURIComponent(quiz.id), {
                                method: "DELETE",
                                headers: { "Content-Type": "application/json" },
                            });
                            if (resp.ok) {
                                // 1) Retirer du DOM
                                card.remove();

                                // 2) Mettre √† jour la source globale
                                if (Array.isArray(window.baseFiltered)) {
                                    window.baseFiltered = window.baseFiltered.filter(q => String(q.id) !== String(quiz.id));
                                }

                                // 3) Relancer le rendu selon les filtres actifs
                                if (typeof window.applyFilters === "function") {
                                    window.applyFilters();
                                } else {
                                    render(window.baseFiltered);
                                }

                                // 4) (Optionnel) Recharger les cat√©gories s‚Äôil n‚Äôen reste plus aucune avec ce label
                                if (typeof loadCategories === "function") {
                                    loadCategories();
                                }
                            } else {
                                const msg = await resp.json().catch(() => ({}));
                                alert(msg.message || "Suppression impossible");
                            }
                        } catch (err) {
                            console.error("Erreur suppression:", err);
                            alert("Erreur serveur pendant la suppression");
                        }
                    });

                    controls.appendChild(delBtn);

                    const editBtn = document.createElement("button");
                    editBtn.type = "button";
                    editBtn.className = "btn-edit";
                    editBtn.textContent = "Modifier";
                    editBtn.style.marginLeft = "8px";
                    editBtn.addEventListener("click", function (e) {
                        e.stopPropagation();
                        var back = "?from=mine";
                        if (mode === "all") {
                            back = "?from=all";
                        }
                        location.href = "/quizzes/" + encodeURIComponent(quiz.id) + "/edit" + back;
                    });

                    controls.appendChild(editBtn);


                    card.appendChild(controls);
                }

                return card;
            };

            try {
                const res = await fetch("/quizzes");
                const quizzes = await res.json();

                let baseFiltered = [];
                if (mode === "mine") {
                    if (me) {
                        baseFiltered = quizzes.filter(
                            (q) => String(q.ownerId || q.auteurId) === String(me.id)
                        );
                    }
                } else {
                    baseFiltered = quizzes.slice();
                }

                function render(list) {
                    grid.innerHTML = "";
                    if (!list.length) {
                        const empty = document.createElement("div");
                        empty.textContent = "Aucun quiz √† afficher.";
                        empty.style.color = "#fff";
                        grid.appendChild(empty);
                        return;
                    }
                    list.forEach((q) => grid.appendChild(createCard(q)));
                }

                window.baseFiltered = baseFiltered;

                // rendu unique
                window.render = function (list) {
                    const grid = document.getElementById("cards-grid");
                    grid.innerHTML = "";
                    if (!list.length) {
                        const empty = document.createElement("div");
                        empty.textContent = "Aucun quiz √† afficher.";
                        empty.style.color = "#fff";
                        grid.appendChild(empty);
                        return;
                    }
                    list.forEach((q) => grid.appendChild(createCard(q)));
                };

                // premier rendu
                render(window.baseFiltered);

                // premier rendu
                render(baseFiltered);

                // maintenant qu'on a baseFiltered et render, on peut charger les cat√©gories
                if (typeof loadCategories === "function") {
                    loadCategories();
                }

                // render(baseFiltered);

                if (typeof loadCategories === "function") {
                    loadCategories();
                }

                const search = document.getElementById("quizSearch");
                if (search) {
                    search.addEventListener("input", () => {
                        const term = normalize(search.value);
                        if (!term) return render(baseFiltered);
                        const subset = baseFiltered.filter((q) => normalize(q.titre).startsWith(term));
                        search.addEventListener("input", () => window.applyFilters());
                        render(subset);
                    });
                }
            } catch (err) {
                console.error("Erreur chargement des quiz:", err);
                const errMsg = document.createElement("div");
                errMsg.textContent = "Erreur de chargement des quiz.";
                errMsg.style.color = "red";
                grid.appendChild(errMsg);
            }
        });
    </script>
</body>

</html>