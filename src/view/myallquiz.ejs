<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebQuizzer â€“ <%= mode==="mine" ? "Mes quiz" : "Tous les quiz" %>
    </title>
    <link rel="stylesheet" href="/home.css" />
</head>

<body>
    <!-- Barre latÃ©rale -->
    <aside class="side-nav">
        <div class="logo">WebQuizzer</div>
        <nav class="side-menu">
            <a href="/" class="side-link">Accueil</a>
            <a href="/quizzes/all" class="side-link <%= mode === " all" ? "active" : "" %>">Tous les quiz</a>
            <a href="/quizzes/mine" class="side-link <%= mode === " mine" ? "active" : "" %>">Mes quiz</a>
            <a href="/quizzes/new" class="side-link create">CrÃ©er</a>
            <% if (user && user.role==="admin" ) { %>
                <a href="/admin" class="side-link create">Admin</a>
                <% } %>
                    <a href="/profile" class="side-link profile-link">ðŸ‘¤ <span>Profil</span></a>
        </nav>

        <div class="side-footer">
            <p id="welcome"></p>
            <a href="/login" id="authButton" class="btn-side-login">Connexion</a>
        </div>
    </aside>

    <!-- Contenu principal -->
    <main class="main">
        <section class="carousel-ribbon" style="padding: 24px;">
            <div id="cards-grid" class="track" style="flex-wrap: wrap; gap: var(--gap);"></div>
        </section>
    </main>

    <!-- DonnÃ©es serveur exposÃ©es -->
    <script>
        window.currentUser = JSON.parse('<%- JSON.stringify(user || null) %>');
        window.pageMode = "<%= mode %>";
    </script>

    <!-- Gestion connexion / dÃ©connexion -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const welcome = document.getElementById("welcome");
            const authBtn = document.getElementById("authButton");
            const me = window.currentUser || null;

            if (me) {
                welcome.textContent = "Bonjour " + me.nom;
                authBtn.textContent = "DÃ©connexion";
                authBtn.href = "#";
                authBtn.onclick = async (e) => {
                    e.preventDefault();
                    try {
                        await fetch("/logout", { method: "GET", credentials: "include" });
                        window.location.href = "/";
                    } catch (err) {
                        alert("Erreur lors de la dÃ©connexion !");
                    }
                };
            } else {
                welcome.textContent = "";
                authBtn.textContent = "Connexion";
                authBtn.href = "/login";
                authBtn.onclick = null;
            }
        });
    </script>

    <!-- Affichage des quiz + suppression -->
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const grid = document.getElementById("cards-grid");
            if (!grid) return;

            const me = window.currentUser || null;
            const mode = window.pageMode;

            const createCard = (quiz) => {
                const card = document.createElement("div");
                card.className = "quiz-card";
                card.setAttribute("data-quiz-id", quiz.id);
                card.innerHTML = `
          <div class="thumb"></div>
          <div class="title">${quiz.titre}</div>
        `;

                // --- Cliquer sur la carte => aller au quiz
                card.style.cursor = "pointer";
                card.addEventListener("click", () => {
                    const back = (mode === "all") ? "?from=all" : (mode === "mine" ? "?from=mine" : "");
                    location.href = "/quizzes/" + encodeURIComponent(quiz.id) + back;
                });

                // --- Bouton Supprimer (fusion logique du carrousel)
                const canDelete =
                    quiz && quiz.id && quiz.id !== "#" &&
                    me &&
                    (me.role === "admin" || String(me.id) === String(quiz.auteurId || quiz.ownerId));

                if (canDelete) {
                    const controls = document.createElement("div");
                    controls.className = "card-controls";

                    const delBtn = document.createElement("button");
                    delBtn.type = "button";
                    delBtn.className = "btn-delete";
                    delBtn.textContent = "Supprimer";

                    delBtn.addEventListener("click", async (e) => {
                        e.stopPropagation();
                        const ok = confirm("Supprimer ce quiz ?");
                        if (!ok) return;

                        try {
                            const resp = await fetch("/quizzes/" + encodeURIComponent(quiz.id), {
                                method: "DELETE",
                                headers: { "Content-Type": "application/json" },
                            });

                            if (resp.ok) {
                                card.remove();
                            } else {
                                const msg = await resp.json().catch(() => ({}));
                                alert(msg.message || "Suppression impossible");
                            }
                        } catch (err) {
                            console.error("Erreur suppression:", err);
                            alert("Erreur serveur pendant la suppression");
                        }
                    });

                    controls.appendChild(delBtn);
                    card.appendChild(controls);
                }

                return card;
            };

            try {
                const res = await fetch("/quizzes");
                const quizzes = await res.json();

                // Filtrage selon le mode (mine / all)
                const idsToShow = [];
                if (mode === "mine") {
                    if (me) {
                        quizzes.forEach((q) => {
                            if (String(q.ownerId || q.auteurId) === String(me.id)) idsToShow.push(String(q.id));
                        });
                    }
                } else {
                    quizzes.forEach((q) => idsToShow.push(String(q.id)));
                }

                // Affichage
                grid.innerHTML = "";
                quizzes.forEach((q) => {
                    if (idsToShow.includes(String(q.id))) {
                        const card = createCard(q);
                        grid.appendChild(card);
                    }
                });

                if (grid.children.length === 0) {
                    const empty = document.createElement("div");
                    empty.textContent = "Aucun quiz Ã  afficher.";
                    empty.style.color = "#fff";
                    grid.appendChild(empty);
                }
            } catch (err) {
                console.error("Erreur chargement des quiz:", err);
                const errMsg = document.createElement("div");
                errMsg.textContent = "Erreur de chargement des quiz.";
                errMsg.style.color = "red";
                grid.appendChild(errMsg);
            }
        });
    </script>
</body>

</html>