<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - Quiz App</title>
    <link rel="stylesheet" href="/home.css" />
    <link rel="stylesheet" href="/profile.css" />
</head>

<body>
    <script>
        window.currentUser = JSON.parse('<%- JSON.stringify(user || null) %>');
    </script>

    <aside class="side-nav">
        <div class="logo">WebQuizzer</div>
        <nav class="side-menu">
            <a href="/" class="side-link">Accueil</a>
            <a href="/quizzes/all" class="side-link">Tous les quiz</a>
            <a href="/quizzes/mine" class="side-link">Mes quiz</a>
            <a href="/quizzes/new" class="side-link create">Cr√©er</a>
            <% if (user && user.role==="admin" ) { %>
                <a href="/admin" class="side-link create">Admin</a>
            <% } %>
            <a href="/profile" class="side-link profile-link active">
                üë§ <span>Profil</span>
            </a>
        </nav>

        <div class="side-footer">
            <p id="welcome"></p>
            <a href="/login" id="authButton" class="btn-side-login">Connexion</a>
        </div>
    </aside>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const welcome = document.getElementById("welcome");
            const authBtn = document.getElementById("authButton");
            const me = window.currentUser || null;

            if (me) {
                welcome.textContent = `Bonjour ${me.nom}`;
                authBtn.textContent = "D√©connexion";
                authBtn.href = "#";

                authBtn.onclick = async (e) => {
                    e.preventDefault();
                    try {
                        await fetch("/logout", { method: "GET", credentials: "include" });
                        localStorage.removeItem("nom");
                        window.location.href = "/";
                    } catch (err) {
                        console.error("Erreur de d√©connexion :", err);
                        alert("Erreur lors de la d√©connexion !");
                    }
                };
            } else {
                welcome.textContent = "";
                authBtn.textContent = "Connexion";
                authBtn.href = "/login";
                authBtn.onclick = null;
            }
        });
    </script>

    <div class="main">
        <div class="page-header">
            <h1>Mon Profil</h1>
            <p class="subtitle">G√©rez vos informations personnelles et param√®tres de compte</p>
        </div>

        <div class="profile-container">
            <% if (typeof message !=="undefined" && message) { %>
                <div class="flash-message">
                    <%= message %>
                </div>
                <% } %>

                    <% if (user) { %>
                        <div class="info-card">
                            <h2>Informations du compte</h2>
                            <div class="info-row">
                                <span class="info-label">Identifiant :</span>
                                <span class="info-value">#<%= user.id %></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Nom :</span>
                                <span class="info-value"><%= user.nom %></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Email :</span>
                                <span class="info-value"><%= user.email %></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">R√¥le :</span>
                                <span class="info-value">
                                    <span class="badge <%= user.role==='admin' ? 'badge-admin' : 'badge-user' %>">
                                        <%= user.role==='admin' ? 'Administrateur' : 'Utilisateur' %>
                                    </span>
                                </span>
                            </div>
                        </div>

                        <div class="forms-grid">
                            <div class="form-card">
                                <h2>Modifier mes informations</h2>
                                <form method="POST" action="/profile/update" autocomplete="on">
                                    <div class="form-group">
                                        <label for="nom">Nom complet</label>
                                        <input id="nom" name="nom" type="text" value="<%= user.nom %>" required placeholder="Votre nom" />
                                    </div>
                                    <div class="form-group">
                                        <label for="email">Adresse email</label>
                                        <input id="email" name="email" type="email" value="<%= user.email %>" required placeholder="votre@email.com" />
                                    </div>
                                    <div class="form-actions">
                                        <button class="btn btn-primary" type="submit">Enregistrer</button>
                                    </div>
                                </form>
                            </div>

                            <div class="form-card">
                                <h2>Changer mon mot de passe</h2>
                                <form method="POST" action="/profile/password" autocomplete="off">
                                    <div class="form-group">
                                        <label for="currentPassword">Mot de passe actuel</label>
                                        <input id="currentPassword" name="currentPassword" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                                    </div>
                                    <div class="form-group">
                                        <label for="newPassword">Nouveau mot de passe</label>
                                        <input id="newPassword" name="newPassword" type="password" minlength="6" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                                    </div>
                                    <div class="form-group">
                                        <label for="confirmPassword">Confirmer le nouveau mot de passe</label>
                                        <input id="confirmPassword" name="confirmPassword" type="password" minlength="6" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                                    </div>
                                    <div class="form-actions">
                                        <button class="btn btn-secondary" type="submit">Modifier</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="danger-zone">
                            <h2>‚ö†Ô∏è Zone de danger</h2>
                            <div class="warning-text">
                                <strong>‚ö†Ô∏è Attention :</strong> La suppression de votre compte est
                                <strong>irr√©versible</strong>.
                                Toutes vos donn√©es, quiz et historique seront d√©finitivement perdus. Tapez
                                <code>DELETE</code> et entrez votre mot de passe pour confirmer cette action.
                            </div>
                            <form method="POST" action="/profile/delete" onsubmit="return confirmDelete();">
                                <div class="form-group">
                                    <label for="confirm">Tapez DELETE pour confirmer</label>
                                    <input id="confirm" name="confirm" type="text" placeholder="DELETE" required />
                                </div>
                                <div class="form-group">
                                    <label for="password">Votre mot de passe</label>
                                    <input id="password" name="password" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                                </div>
                                <div class="form-actions">
                                    <button class="btn btn-danger" type="submit">Supprimer d√©finitivement mon compte</button>
                                    <a class="link" href="/">Annuler</a>
                                </div>
                            </form>
                        </div>
                        <% } else { %>
                            <div class="not-logged-in">
                                <h2>Acc√®s restreint</h2>
                                <p>Vous devez √™tre connect√© pour acc√©der √† votre profil.</p>
                                <a href="/login" class="btn btn-primary">Se connecter</a>
                            </div>
                            <% } %>
        </div>
    </div>

    <script>
        function confirmDelete() {
            return confirm("‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\n√ätes-vous absolument s√ªr de vouloir supprimer d√©finitivement votre compte ?\n\nCette action est IRR√âVERSIBLE et entra√Ænera la perte de toutes vos donn√©es.\n\nCliquez sur OK pour confirmer la suppression.");
        }

        const flashMessage = document.querySelector('.flash-message');
        if (flashMessage) {
            setTimeout(() => {
                flashMessage.style.opacity = '0';
                flashMessage.style.transition = 'opacity 0.5s ease';
                setTimeout(() => flashMessage.remove(), 500);
            }, 5000);
        }
    </script>
</body>

</html>
