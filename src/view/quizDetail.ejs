<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= quiz.titre %> - Quiz
  </title>
  <link rel="stylesheet" href="/login.css">
  <link rel="stylesheet" href="/quiz.css">
</head>

<body>
  <div class="container">
    <a href="#" class="close-btn" onclick="goBack(event)">âœ–</a>

    <script>
      function goBack(e) {
        e.preventDefault();
        if (document.referrer && document.referrer !== window.location.href) {
          window.location.href = document.referrer;
        } else {
          window.history.back();
        }
      }
    </script>

    <h1>
      <%= quiz.titre %>
    </h1>
    <p class="subtitle">RÃ©pondez aux <%= quiz.questions.length %> questions</p>

    <form id="quizForm" class="quiz-content">
      <% quiz.questions.forEach((q, index)=> { %>
        <div class="question-card" data-question-id="<%= q.id %>">
          <div class="question-number">Question <%= index + 1 %> / <%= quiz.questions.length %>
          </div>
          <div class="question-text">
            <%= q.enonce %>
          </div>

          <div class="choices">
            <% q.choisir.forEach((choix)=> { %>
              <label class="choice-label" data-choice-id="<%= choix.id %>">
                <% if (q.types==='multiple' ) { %>
                  <input type="checkbox" name="q_<%= q.id %>" value="<%= choix.id %>">
                  <% } else { %>
                    <input type="radio" name="q_<%= q.id %>" value="<%= choix.id %>">
                    <% } %>
                      <span class="choice-text">
                        <%= choix.texte %>
                      </span>
              </label>
              <% }); %>
          </div>
        </div>
        <% }); %>

          <button type="submit" class="btn-submit">Valider mes rÃ©ponses</button>
    </form>

    <div id="result" class="result">
      <div id="resultMessage"></div>
      <div class="score" id="scoreDisplay"></div>
    </div>
  </div>

  <script>
    const quizForm = document.getElementById('quizForm');
    const resultDiv = document.getElementById('result');
    const resultMessage = document.getElementById('resultMessage');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const quizId = "<%= quiz.id %>";

    const corrections = JSON.parse('<%- JSON.stringify(quiz.questions.map(q => ({ id: q.id, correction: q.correction }))) %>');

    quizForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      let score = 0;
      const totalQuestions = corrections.length;
      const answers = {}; // pour envoyer au serveur

      corrections.forEach(({ id, correction }) => {
        const questionCard = document.querySelector(`[data-question-id="${id}"]`);
        const inputs = questionCard.querySelectorAll('input:checked');
        const userAnswers = Array.from(inputs).map(input => input.value);

        answers[id] = userAnswers.length <= 1 ? userAnswers[0] || "" : userAnswers; // stocke pour POST

        const isCorrect =
          userAnswers.length === correction.length &&
          userAnswers.every(ans => correction.includes(ans));

        if (isCorrect) {
          score++;
          questionCard.classList.add('correct');
        } else {
          questionCard.classList.add('incorrect');
        }

        questionCard.querySelectorAll('.choice-label').forEach(label => {
          const choiceId = label.getAttribute('data-choice-id');
          const input = label.querySelector('input');
          const isChecked = input.checked;
          const isCorrectAnswer = correction.includes(choiceId);

          if (isCorrectAnswer) {
            label.classList.add('correct-answer');
          }
          if (isChecked && !isCorrectAnswer) {
            label.classList.add('wrong-answer');
          }
        });

        questionCard.querySelectorAll('input').forEach(input => {
          input.disabled = true;
        });
      });

      const percentage = Math.round((score / totalQuestions) * 100);
      resultDiv.classList.add('show');

      if (percentage >= 50) {
        resultDiv.classList.add('success');
        resultDiv.classList.remove('error');
        resultMessage.textContent = 'ðŸŽ‰ FÃ©licitations !';
      } else {
        resultDiv.classList.add('error');
        resultDiv.classList.remove('success');
        resultMessage.textContent = 'ðŸ˜” Vous pouvez mieux faire !';
      }

      scoreDisplay.textContent = `Score : ${score} / ${totalQuestions} (${percentage}%)`;

      e.target.querySelector('button[type="submit"]').disabled = true;
      e.target.querySelector('button[type="submit"]').style.opacity = '0.5';
      e.target.querySelector('button[type="submit"]').style.cursor = 'not-allowed';

      resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

      // ENVOI DES POINTS AU SERVEUR
      try {
        const res = await fetch("/score/award", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ quizId, answers }),
          credentials: "include",
        });
        const data = await res.json();
        if (res.ok) {
          console.log("Points ajoutÃ©s :", data);
          alert(`+${data.gained} point(s) ajoutÃ©s Ã  ton score ! Total : ${data.total} points`);
        } else {
          console.warn("Erreur attribution points :", data.message);
        }
      } catch (err) {
        console.error("Erreur envoi score :", err);
      }
    });
  </script>
</body>

</html>