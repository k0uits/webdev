<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/img/logo_webQuizzer.png">

  <title>WebQuizzer ‚Äì Accueil</title>
  <link rel="stylesheet" href="../home.css" />
</head>

<body>
  <!-- Expose l'utilisateur connect√© c√¥t√© client -->
  <script>
    window.currentUser = JSON.parse('<%- JSON.stringify(user || null) %>');
  </script>

  <aside class="side-nav">
    <div class="logo">WebQuizzer</div>
    <nav class="side-menu">
      <a href="/" class="side-link active">Accueil</a>
      <a href="/quizzes/all" class="side-link">Tous les quiz</a>
      <a href="/quizzes/mine" class="side-link">Mes quiz</a>
      <a href="/quizzes/new" class="side-link create">Cr√©er</a>
      <% if (user && user.role==="admin" ) { %>
        <a href="/admin" class="side-link create">Admin</a>
        <% } %>
          <a href="/profile" class="side-link profile-link">üë§ <span>Profil</span></a>
    </nav>

    <div class="side-footer">
      <p id="welcome"></p>
      <a href="/login" id="authButton" class="btn-side-login">Connexion</a>
    </div>
  </aside>

  <main class="main">
    <section class="carousel-ribbon">
      <div class="marquee">
        <div class="track primary"></div>
        <div class="track clone" aria-hidden="true"></div>
      </div>
    </section>

    <!-- ==== LEADERBOARD RENDU EN EJS ==== -->
    <section class="leaderboard">
      <h2>üèÜ Classement</h2>

      <% const lb=Array.isArray(leaderboard) ? leaderboard.slice() : []; lb.sort((a,b)=> Number(b.points||0) -
        Number(a.points||0));
        const top3 = lb.slice(0,3);
        const rest = lb.slice(3);
        const medal = (i) => (i===0?'ü•á':i===1?'ü•à':'ü•â');
        %>

        <div class="podium">
          <% top3.forEach((u, i)=> { %>
            <div class="podium-spot <%= i===0?'first':(i===1?'second':'third') %>">
              <div class="medal">
                <%= medal(i) %>
              </div>
              <div class="name">
                <%= u.nom %>
              </div>
              <div class="pts">
                <%= Number(u.points||0) %> pts
              </div>
            </div>
            <% }) %>
              <% if (top3.length===0) { %>
                <div class="rank-row">Aucun utilisateur pour le moment.</div>
                <% } %>
        </div>

        <div class="ranking-list">
          <% rest.forEach((u, i)=> { %>
            <div class="rank-row">
              <span class="pos">
                <%= i + 4 %>.
              </span>
              <span class="name">
                <%= u.nom %>
              </span>
              <span class="pts">
                <%= Number(u.points||0) %> pts
              </span>
            </div>
            <% }) %>
        </div>
    </section>
  </main>

  <!-- GESTION CONNEXION -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const welcome = document.getElementById("welcome");
      const authBtn = document.getElementById("authButton");
      const me = window.currentUser || null;

      if (me) {
        welcome.textContent = `Bonjour ${me.nom}`;
        authBtn.textContent = "D√©connexion";
        authBtn.href = "#";
        authBtn.onclick = async (e) => {
          e.preventDefault();
          try {
            await fetch("/logout", { method: "GET", credentials: "include" });
            window.location.href = "/";
          } catch (err) {
            console.error("Erreur de d√©connexion :", err);
            alert("Erreur lors de la d√©connexion !");
          }
        };
      } else {
        welcome.textContent = "";
        authBtn.textContent = "Connexion";
        authBtn.href = "/login";
        authBtn.onclick = null;
      }
    });
  </script>

  <!-- CHARGEMENT DYNAMIQUE DES QUIZ (carrousel) -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const TOTAL_CASES = 7;
      const track1 = document.querySelector(".track.primary");
      const track2 = document.querySelector(".track.clone");
      if (!track1) return;

      const me = window.currentUser || null;

      const createCard = (quiz) => {
        const card = document.createElement("div");
        card.className = "quiz-card";
        card.setAttribute("data-quiz-id", quiz.id);

        const thumb = document.createElement("div");
        thumb.className = "thumb";

        if (quiz.image) {
          thumb.style.backgroundImage = `url('${quiz.image}')`;
          thumb.style.backgroundSize = "cover";
          thumb.style.backgroundPosition = "center";
          thumb.style.border = "none";
          thumb.style.backgroundColor = "transparent";
        }

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = quiz.titre;

        card.appendChild(thumb);
        card.appendChild(title);

        card.style.cursor = "pointer";
        card.addEventListener("click", () => {
          location.href = "/quizzes/" + encodeURIComponent(quiz.id);
        });

        const me = window.currentUser || null;
        const canDelete =
          quiz && quiz.id && quiz.id !== "#" && me &&
          (me.role === "admin" || String(me.id) === String(quiz.auteurId));

        if (canDelete) {
          const controls = document.createElement("div");
          controls.className = "card-controls";

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn-delete";
          delBtn.textContent = "Supprimer";
          delBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const ok = confirm("Supprimer ce quiz ?");
            if (!ok) return;

            try {
              const resp = await fetch("/quizzes/" + encodeURIComponent(quiz.id), {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
              });
              if (resp.ok) {
                card.remove();
                updateClone();
              } else {
                const msg = await resp.json().catch(() => ({}));
                alert(msg.message || "Suppression impossible");
              }
            } catch (err) {
              console.error("Erreur suppression:", err);
              alert("Erreur serveur pendant la suppression");
            }
          });

          controls.appendChild(delBtn);
          card.appendChild(controls);
        }

        return card;
      };


      const updateClone = () => {
        if (!track2) return;
        track2.innerHTML = "";
        track1.childNodes.forEach((node) => {
          const clone = node.cloneNode(true);
          if (node.classList && node.classList.contains('quiz-card')) {
            const quizId = node.getAttribute('data-quiz-id');
            if (quizId) {
              clone.style.cursor = "pointer";
              clone.addEventListener("click", () => {
                location.href = "/quizzes/" + encodeURIComponent(quizId);
              });
              const delBtn = clone.querySelector('.btn-delete');
              if (delBtn) {
                delBtn.addEventListener("click", async (e) => {
                  e.stopPropagation();
                  const ok = confirm("Supprimer ce quiz ?");
                  if (!ok) return;
                  try {
                    const resp = await fetch("/quizzes/" + encodeURIComponent(quizId), {
                      method: "DELETE",
                      headers: { "Content-Type": "application/json" },
                    });
                    if (resp.ok) {
                      node.remove();
                      clone.remove();
                      updateClone();
                    } else {
                      const msg = await resp.json().catch(() => ({}));
                      alert(msg.message || "Suppression impossible");
                    }
                  } catch (err) {
                    console.error("Erreur suppression:", err);
                    alert("Erreur serveur pendant la suppression");
                  }
                });
              }
            }
          }
          track2.appendChild(clone);
        });
      };

      try {
        const res = await fetch("/quizzes");
        const quizzes = await res.json();

        track1.innerHTML = "";
        let i = 0;
        while (i < quizzes.length && i < TOTAL_CASES) {
          const q = quizzes[i++];
          const card = createCard(q);
          track1.appendChild(card);
        }
        while (i < TOTAL_CASES) {
          const placeholder = createCard({ id: "#", titre: "Titre du quiz" });
          track1.appendChild(placeholder);
          i++;
        }
        updateClone();
      } catch (err) {
        console.error("Erreur chargement des quiz:", err);
        const errMsg = document.createElement("div");
        errMsg.textContent = "Erreur de chargement des quiz.";
        errMsg.style.color = "red";
        track1.appendChild(errMsg);
      }
    });
  </script>
</body>

</html>